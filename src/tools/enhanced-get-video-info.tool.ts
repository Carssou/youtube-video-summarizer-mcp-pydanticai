import { z } from "zod";
import { enhancedYouTubeClient } from "../clients/enhanced-youtube-client.js";
import { ToolDefinition } from "../types/tool-definition.js";

const toolName = "get_video_info";
const toolDescription = "Get comprehensive information about a YouTube video including title, description, duration, captions, and access status";
const toolSchema = {
  videoUrl: z.string().describe("The URL or ID of the YouTube video"),
  languageCode: z.string().describe("The language code for captions (optional, e.g., 'en', 'es', 'fr')").optional(),
};

const toolHandler = async (args: { videoUrl: string; languageCode?: string }, _extra: { signal: AbortSignal }) => {
  const result = await enhancedYouTubeClient.getEnhancedVideoInfo(args.videoUrl, args.languageCode);

  if (!result.success) {
    return {
      content: [
        {
          type: "text" as const,
          text: `âŒ **Error getting video info**: ${result.error}\n\n**Attempted methods**: ${result.fallbackUsed?.join(", ") || "None"}\n\n**Troubleshooting tips**:\n- Check if the video URL is correct\n- Ensure the video is public and accessible\n- Try with a different video to test the tool`,
        },
      ],
    };
  }

  const videoInfo = result.data!;
  
  // Format captions text
  let captionsText = "";
  if (videoInfo.captionsAvailable && videoInfo.subtitles && videoInfo.subtitles.length > 0) {
    captionsText = videoInfo.subtitles.map(subtitle => subtitle.text).join(". ");
  }

  // Create comprehensive response
  let responseText = `# ğŸ“º YouTube Video Information\n\n`;
  
  // Basic Info
  responseText += `**ğŸ¬ Title**: ${videoInfo.title}\n\n`;
  responseText += `**ğŸ“º Channel**: ${videoInfo.channelTitle}\n\n`;
  responseText += `**â±ï¸ Duration**: ${videoInfo.duration}\n\n`;
  responseText += `**ğŸ“… Published**: ${videoInfo.publishedAt}\n\n`;
  
  // Statistics (if available)
  if (videoInfo.viewCount) {
    responseText += `**ğŸ‘ï¸ Views**: ${parseInt(videoInfo.viewCount).toLocaleString()}\n\n`;
  }
  if (videoInfo.likeCount) {
    responseText += `**ğŸ‘ Likes**: ${parseInt(videoInfo.likeCount).toLocaleString()}\n\n`;
  }
  
  // Access Status
  const statusEmoji = {
    'public': 'ğŸŒ',
    'unlisted': 'ğŸ”—',
    'private': 'ğŸ”’',
    'restricted': 'âš ï¸',
    'unknown': 'â“'
  };
  responseText += `**${statusEmoji[videoInfo.accessStatus]} Access**: ${videoInfo.accessStatus.charAt(0).toUpperCase() + videoInfo.accessStatus.slice(1)}\n\n`;
  
  // Captions Status with clear warning
  if (videoInfo.captionsAvailable) {
    responseText += `**ğŸ“ Captions**: âœ… Available (${videoInfo.subtitles?.length || 0} segments)\n\n`;
  } else {
    responseText += `**ğŸ“ Captions**: âŒ Not available\n\n`;
    responseText += `âš ï¸ **Note**: This video has no accessible captions/transcript. Summarization is limited to video description and metadata only. For detailed content analysis, captions are required.\n\n`;
  }
  
  // Description
  responseText += `**ğŸ“„ Description**:\n${videoInfo.description}\n\n`;
  
  // Captions (if available)
  if (videoInfo.captionsAvailable && captionsText) {
    responseText += `**ğŸ“‹ Captions/Transcript**:\n${captionsText}\n\n`;
  }
  
  // Technical Info
  responseText += `**ğŸ”§ Extraction Methods Used**: ${result.fallbackUsed?.join(" â†’ ") || "Unknown"}\n\n`;
  
  // Thumbnails
  if (videoInfo.thumbnails.high) {
    responseText += `**ğŸ–¼ï¸ Thumbnail**: ${videoInfo.thumbnails.high}\n\n`;
  }

  // Note creation suggestion
  const noteTitle = `${videoInfo.title} - Generated by Assistant`;
  responseText += `**ğŸ“ Suggested Note Title**: "${noteTitle}"\n\n`;

  return {
    content: [
      {
        type: "text" as const,
        text: responseText,
      },
    ],
  };
};

export const EnhancedGetVideoInfoTool: ToolDefinition<typeof toolSchema> = {
  name: toolName,
  description: toolDescription,
  schema: toolSchema,
  handler: toolHandler,
};